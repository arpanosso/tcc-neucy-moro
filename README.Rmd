---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  error = FALSE,
  warning = FALSE,
  eval = TRUE,
  comment = "#>"
)
```

# TCC Neucy - Dados Climáticos

<!-- badges: start -->
<!-- badges: end -->

## Carregando pacotes

```{r}
library(tidyverse)
library(trend)
library(ggpubr)
library(corrplot)
library(vegan)
```

## Carregando dados

```{r}
dados_climatico <- read_rds("data/dados-climaticos.rds")
glimpse(dados_climatico)
```

## Gráfico 

```{r}
plot_climograma <- dados_climatico |> 
  select(data, temp_max, temp_min, temp_media, precipitacao) |> 
  pivot_longer(cols = temp_max:temp_media,
               names_to = "variavel",
               values_to = "valores") |> 
  mutate(
    variavel = case_when(
      variavel == "temp_max" ~ "Maxima",
      variavel == "temp_media" ~ "Media",
      variavel == "temp_min" ~ "Minima"
    )
  ) |> 
  ggplot(aes(x = data)) +
  # barras de precipitação (em escala secundária)
  geom_line(aes(y = valores, color = variavel), size = .25) +
  geom_col(aes(y = precipitacao * 0.2),  # ajuste o fator (0.2) conforme a escala
           fill = "skyblue4") +
  # linhas de temperatura
  theme_bw() +
  scale_color_manual(values = c("gray", "black", "darkgray")) +
  scale_y_continuous(
    name = "Temperatura (oC)",
    limits = c(0, 40), 
    sec.axis = sec_axis(~./0.3, name = "Precipitacao (mm)") # inverso do fator usado
  ) +
  labs(
    color = "",
    x = "Data"
  ) +
  theme(
    legend.position = "top"
  ) 
print(plot_climograma)
```

## Estatísticas descritivas gerais

```{r}
resumo_geral <- dados_climatico  |>
  summarise(
    temp_min_media = mean(temp_min, na.rm = TRUE),
    temp_med_media = mean(temp_media, na.rm = TRUE),
    temp_max_media = mean(temp_max, na.rm = TRUE),
    prec_media = mean(precipitacao, na.rm = TRUE),
    temp_min_sd = sd(temp_min, na.rm = TRUE),
    temp_med_sd = sd(temp_media, na.rm = TRUE),
    temp_max_sd = sd(temp_max, na.rm = TRUE),
    prec_sd = sd(precipitacao, na.rm = TRUE),
    n_dias = n()
  )
resumo_geral
```
##  Estatísticas mensais

```{r}
resumo_mensal <- dados_climatico  |>
  group_by(ano, mes)  |>
  summarise(
    temp_min = mean(temp_min, na.rm = TRUE),
    temp_med = mean(temp_media, na.rm = TRUE),
    temp_max = mean(temp_max, na.rm = TRUE),
    prec_total = sum(precipitacao, na.rm = TRUE),
    .groups = "drop"
  )
resumo_mensal
```

## Gráficos de tendência temporal

### Temperatura média diária

```{r}
dados_climatico |>
  ggplot(aes(x = data, y = temp_media)) +
  geom_line(color = "darkred", alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE, color = "black") +
  labs(title = "Temperatura media diaria", x = "Data", y = "oC") +
  theme_minimal()
```

## Precipitação diária

```{r}
dados_climatico |>
  ggplot(aes(x = data, y = precipitacao)) +
  geom_col(fill = "steelblue4") +
  labs(title = "Precipitacao diaria", x = "Data", y = "mm") +
  theme_minimal() +
  facet_wrap(~ano,scale="free") +
  theme(
    axis.text.x = element_text(angle = 45)
  )
```

## Boxplots mensais (sazonalidade)

```{r}
dados_climatico |>
  ggplot(aes(x = as_factor(mes), y = temp_media)) +
  geom_boxplot(fill = "orange4", alpha = 0.7) +
  labs(title = "Distribuicao mensal da temperatura media",
       x = "Mes", y = "oC") +
  theme_minimal()
```


```{r}
dados_climatico |>
  ggplot(aes(x = as_factor(mes), y = precipitacao)) +
  geom_boxplot(fill = "skyblue3", alpha = 0.7) +
  labs(title = "Distribuicao mensal da precipitacao diaria",
       x = "Mes", y = "mm") +
  theme_minimal()
```

## Correlação entre variáveis

```{r}
cor_matriz <- dados_climatico %>%
  select(temp_min, temp_media, temp_max, precipitacao) %>%
  cor(use = "pairwise.complete.obs")

corrplot(cor_matriz, method = "color", addCoef.col = "grey6")
```

## Análises de extremos

```{r}
# Dias de chuva
dias_chuva <- sum(dados_climatico$precipitacao > 1, na.rm = TRUE)

# Dias secos consecutivos
dias_secos <- rle(dados_climatico$precipitacao == 0)$lengths
max_dias_secos <- max(dias_secos)

# Ondas de calor (dias com T > p90)
limite_calor <- quantile(dados_climatico$temp_max, 0.9, na.rm = TRUE)
ondas_calor <- sum(dados_climatico$temp_max > limite_calor, na.rm = TRUE)
dias_chuva
max_dias_secos
ondas_calor
```


```{r}
# Gráfico tipo climograma
climograma <- resumo_mensal %>%
  ggplot(aes(x = mes)) +
  geom_col(aes(y = prec_total), fill = "steelblue4", alpha = 0.6) +
  geom_line(aes(y = temp_med * 50, group = 1), color = "red", size = 1.1) +
  scale_y_continuous(
    name = "Precipitacao (mm)",
    sec.axis = sec_axis(~./50, name = "Temperatura media (oC)")
  ) +
  labs(title = "Climograma - Precipitacao e Temperatura Media Mensal") +
  theme_minimal()

print(climograma)
```

## Tendência temporal (Mann-Kendall)

```{r}
teste_temp <- mk.test(dados_climatico$temp_media)
print(teste_temp)
```

```{r}
ggplot(dados_climatico, aes(x = data, y = temp_media)) +
  geom_line(alpha = 0.6, color = "red4") +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  labs(title = "Tendencia temporal da temperatura media (2020–2025)",
       x = "Data", y = "Temperatura media (oC)") +
  theme_minimal()
```

# TCC Neucy - Dados Fenotípicos

## Carregando dados

```{r}
dados_fenotipicos <- read_rds("data/dados-tcc-neucy.rds")
skimr::skim(dados_fenotipicos)
```

## Função para criar chuva acumulada e média de temperatura

```{r}
get_climate_features <- function(data_ref, 
                                 janela = 15,
                                 df_ref,
                                 feature = "chuva_acumulada"){
  data_ref = lubridate::as_date(data_ref) 
  data_l = lubridate::as_date(data_ref) - days(janela)
  df_aux = df_ref |> 
    filter(data >= data_l & data <= data_ref)
  
  sum_prec = sum(df_aux$precipitacao)
  dias_chuva = sum(df_aux$precipitacao>=1)
  dias_secos = sum(df_aux$precipitacao == 0)
  seco = df_aux$precipitacao < 1
  rle_seco = rle(seco)
  max_dry = ifelse(any(rle_seco$values), max(rle_seco$lengths[rle_seco$values]), 0)
  temp_media = mean(df_aux$temp_media) 
  if(feature == "chuva_acumulada" ) return(sum_prec)
  if(feature == "dias_chuva" ) return(dias_chuva)
  if(feature == "dias_secos" ) return(dias_secos)
  if(feature == "max_dias_secos" ) return(max_dry)
  if(feature == "temp_media" ) return(temp_media)
}
get_climate_features(lubridate::as_date("2020-11-18"),15,dados_climatico,"chuva_acumulada")
get_climate_features(lubridate::as_date("2020-11-18"),30,dados_climatico,"chuva_acumulada")
```


```{r}
# dados <- dados_fenotipicos |> 
#   # slice(1:10) |> 
#   rowwise() |>
#   mutate(
#      duracao_floresc = as.numeric(data_floresc - data_sem),
#      duracao_ciclo = as.numeric(data_ciclo - data_sem),
#      chuva_total_floresc = get_climate_features(data_floresc,duracao_floresc,
#                                               dados_climatico,"chuva_acumulada"),
#      chuva_total_ciclo = get_climate_features(data_ciclo,duracao_ciclo,
#                                               dados_climatico,"chuva_acumulada"),
#      chuva_15d_sem = get_climate_features(data_sem,15,dados_climatico,"chuva_acumulada"),
#      chuva_30d_sem = get_climate_features(data_sem,45,dados_climatico,"chuva_acumulada"),
#      chuva_15d_floresc = get_climate_features(data_floresc,janela = 15,df_ref = dados_climatico,"chuva_acumulada"),
#      chuva_30d_floresc = get_climate_features(data_floresc,45,dados_climatico,"chuva_acumulada"),
#      dias_chuva_30d = get_climate_features(data_ciclo,30,
#                                               dados_climatico,"dias_chuva"),
#      dias_secos_30d = get_climate_features(data_ciclo,30,
#                                               dados_climatico,"dias_secos"),
#      max_dias_secos_30d = get_climate_features(data_ciclo,30,
#                                               dados_climatico,"max_dias_secos"),
#      temp_media_15d_sem = get_climate_features(data_sem,15,
#                                                dados_climatico,"temp_media"),
#      temp_media_30d_sem = get_climate_features(data_sem,30,
#                                                dados_climatico,"temp_media"),
#      temp_media_15d_floresc = get_climate_features(data_floresc,15,
#                                                dados_climatico,"temp_media"),
#      temp_media_30d_floresc = get_climate_features(data_floresc,30,
#                                                dados_climatico,"temp_media"),
#      temp_media_floresc = get_climate_features(data_floresc,duracao_floresc,
#                                                dados_climatico,"temp_media"),
#      temp_media_ciclo = get_climate_features(data_floresc,duracao_ciclo,
#                                                dados_climatico,"temp_media"),
#   ) 
# write_rds(dados,"data/dados-agregados.rds")
```


# DADOS AGREGADOS

```{r}
dados <- read_rds("data/dados-agregados.rds")
glimpse(dados)  
```

## Análise Multivariada por safra

```{r}
agrupamentos <- c(4,4,4,4,4)
safras <- unique(dados$safra)
epocas <- unique(dados$epoca)
for(i in seq_along(safras)){
  # for(j in seq_along(epocas)){
    df_aux <- dados |> 
      filter(
        safra == safras[i],
        # epoca == epocas[j]
      ) |> 
      group_by(cultivar,epoca) |> 
      summarise(across(.cols = ap:temp_media_ciclo,
                       .fns = mean,
                       .names = "{.col}" 
                       
      )) |> ungroup()
    dados_aux <- df_aux |>  select(-cultivar,-epoca,-duracao_floresc,
                                   -duracao_ciclo)
    cultivar <- df_aux$cultivar
    if(nrow(dados_aux) > 10){
      mc <- cor(dados_aux)
      fc <- !is.na(mc[1,])
      fl <- !is.na(mc[,1])
      mc <- mc[fc,fl]
      print("=================================================================")
      print(paste0("ANALISE PARA SAFRA: ",safras[i]))#,"; EPOCA: ",epocas[j]))
      print("=================================================================")
      
      corrplot(mc[1:6,-(1:6)],method = "color",
                         outline = TRUE,
                         addgrid.col = "darkgray",cl.pos = "r", tl.col = "black",
                         tl.cex = 1, cl.cex = 1,  bg="azure2",
                         # diag = FALSE,
                         addCoef.col = "black",
                         cl.ratio = 0.2,
                         cl.length = 5,
                         number.cex = 0.8
                         ) 
      nomes <- colnames(mc)
      da_pad<-decostand(dados_aux |> 
                          select(nomes), 
                          method = "standardize",
                        na.rm=TRUE)
      da_pad_euc<-vegdist(da_pad,"euclidean") 
      da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
      da_pad_euc_ward$labels <- cultivar
      grupo<-cutree(da_pad_euc_ward,agrupamentos[i])
      d <- da_pad_euc_ward$height
      d_corte <- d[which(d |> diff() == max(diff(d)))]
      plot(da_pad_euc_ward, 
           ylab="Distância Euclidiana",
           xlab="Acessos", hang=-1,
           col="blue", las=1,
           cex=.6,lwd=1.5);box();abline(h=d_corte*1.15)
      
      print("======== Análise de Componentes Principais ========== ")
      pca <-  prcomp(da_pad,scale.=TRUE)
      # Autovalores
      eig<-pca$sdev^2
      print("==== Autovalores ====")
      print(round(eig,3))
      print("==== % da variância explicada ====")
      ve<-eig/sum(eig)
      print(round(ve,4))
      print("==== % da variância explicada acumulada ====")
      print(round(cumsum(ve),4)*100)
      print("==== Poder Discriminante ====")
      mcor<-cor(da_pad,pca$x)
      corrplot(mcor)
      print("==== screeplot ====")
      # screeplot(pca);abline(h=1)
      
      pc1V<-cor(da_pad,pca$x)[,1]/sd(cor(da_pad,pca$x)[,1])
      pc2V<-cor(da_pad,pca$x)[,2]/sd(cor(da_pad,pca$x)[,2])
      pc3V<-cor(da_pad,pca$x)[,3]/sd(cor(da_pad,pca$x)[,3])
      pc1c<-pca$x[,1]/sd(pca$x[,1])
      pc2c<-pca$x[,2]/sd(pca$x[,2])
      pc3c<-pca$x[,3]/sd(pca$x[,3])
      nv<-ncol(mc) # número de variáveis utilizadas na análise
      
      # gráfico biplot
      bip<-data.frame(pc1c,pc2c,pc3c,grupo)
      texto <- data.frame(
        x = pc1V,
        y = pc2V,
        z = pc3V,
        label = rownames(mc)
      )
      for(k in 1:agrupamentos[i]){
        cat("[Grupo ", paste(k,"]:",cultivar[grupo==k],collapse = "\n"))
        cat("\n\n")
      }
    

      bi_plot <- bip |> 
        ggplot(aes(x=pc1c,y=pc2c,colour = as_factor(grupo))) +
        geom_point(size = 3) +
        theme_minimal() +
        # scale_shape_manual(values=16:18)+
        # scale_color_manual(values=c("#009E73", "#D55E00")) + #"#999999",
        # annotate(geom="text", x=pc1c, y=pc2c, label=cultivar,
        #             color="black",size=.25)+
        geom_vline(aes(xintercept=0),
                   color="black", size=1)+
        geom_hline(aes(yintercept=0),
                   color="black", size=1)+
        annotate(geom="segment",
                 x=rep(0,nv),
                 xend=texto$x,
                 y=rep(0,nv),
                 yend=texto$y,color="black",lwd=.5)+
        geom_label(data=texto,aes(x=x,y=y,label=label),
                   color="black",angle=0,fontface="bold",size=3,fill="white")+
        labs(x=paste("CP1 (",round(100*ve[1],2),"%)",sep=""),
             y=paste("CP2 (",round(100*ve[2],2),"%)",sep=""),
             color="",shape="")+
        theme(legend.position = "top")+
        xlim(min(pc1c)*1.5,max(pc1c)*1.5) 
      print(bi_plot)
      
      print("==== Tabela da correlação dos atributos com cada PC ====")
      ck<-sum(pca$sdev^2>=0.98)
      tabelapca<-vector()
      for( l in 1:ck) tabelapca<-cbind(tabelapca,mcor[,l])
      colnames(tabelapca)<-paste(rep(c("PC"),ck),1:ck,sep="")
      pcat<-round(tabelapca,3)
      tabelapca<-tabelapca[order(abs(tabelapca[,1])),]
      print(tabelapca)
    }
  # }
}

```


## Análise multivariada total

```{r}
df_aux <- dados |> 
  group_by(cultivar) |> 
  summarise(across(.cols = ap:temp_media_ciclo,
                   .fns = mean,
                   .names = "{.col}" 
                   
  )) |> 
  ungroup()
```


```{r}
dados_aux <- df_aux |>  select(-cultivar,-duracao_floresc,
                               -duracao_ciclo)
cultivar <- df_aux$cultivar

mc <- cor(dados_aux)
fc <- !is.na(mc[1,])
fl <- !is.na(mc[,1])
mc <- mc[fc,fl]
```


```{r}
corrplot(mc[1:6,-(1:6)],method = "color",
         outline = TRUE,
         addgrid.col = "darkgray",cl.pos = "r", tl.col = "black",
         tl.cex = 1, cl.cex = 1,  bg="azure2",
         # diag = FALSE,
         addCoef.col = "black",
         cl.ratio = 0.2,
         cl.length = 5,
         number.cex = 0.8
)
```


```{r}
nomes <- colnames(mc)
da_pad<-decostand(dados_aux |> 
                    select(nomes), 
                  method = "standardize",
                  na.rm=TRUE)
da_pad_euc<-vegdist(da_pad,"euclidean") 
da_pad_euc_ward<-hclust(da_pad_euc, method="ward.D")
da_pad_euc_ward$labels <- cultivar
grupo<-cutree(da_pad_euc_ward,5)
d <- da_pad_euc_ward$height
d_corte <- d[which(d |> diff() == max(diff(d)))]
plot(da_pad_euc_ward, 
     ylab="Distância Euclidiana",
     xlab="Acessos", hang=-1,
     col="blue", las=1,
     cex=.6,lwd=1.5);box();abline(h=d_corte*1.15)
```


```{r}
pca <-  prcomp(da_pad,scale.=TRUE)
# Autovalores
eig<-pca$sdev^2
print("==== Autovalores ====")
print(round(eig,3))
print("==== % da variância explicada ====")
ve<-eig/sum(eig)
print(round(ve,4))
print("==== % da variância explicada acumulada ====")
print(round(cumsum(ve),4)*100)
print("==== Poder Discriminante ====")
```


```{r}
mcor<-cor(da_pad,pca$x)
corrplot(mcor)
```


```{r}
pc1V<-cor(da_pad,pca$x)[,1]/sd(cor(da_pad,pca$x)[,1])
pc2V<-cor(da_pad,pca$x)[,2]/sd(cor(da_pad,pca$x)[,2])
pc3V<-cor(da_pad,pca$x)[,3]/sd(cor(da_pad,pca$x)[,3])
pc1c<-pca$x[,1]/sd(pca$x[,1])
pc2c<-pca$x[,2]/sd(pca$x[,2])
pc3c<-pca$x[,3]/sd(pca$x[,3])
nv<-ncol(mc) # número de variáveis utilizadas na análise

# gráfico biplot
bip<-data.frame(pc1c,pc2c,pc3c,grupo)
texto <- data.frame(
  x = pc1V,
  y = pc2V,
  z = pc3V,
  label = rownames(mc)
)
for(k in 1:max(grupo)){
  cat("[Grupo ", paste0(k,"]: ",cultivar[grupo==k],collapse = "\n"))
  cat("\n\n")
}


bi_plot <- bip |> 
  ggplot(aes(x=pc1c,y=pc2c,colour = as_factor(grupo))) +
  geom_point(size = 3) +
  theme_minimal() +
  # scale_shape_manual(values=16:18)+
  # scale_color_manual(values=c("#009E73", "#D55E00")) + #"#999999",
  # annotate(geom="text", x=pc1c, y=pc2c, label=cultivar,
  #             color="black",size=.25)+
  geom_vline(aes(xintercept=0),
             color="black", size=1)+
  geom_hline(aes(yintercept=0),
             color="black", size=1)+
  annotate(geom="segment",
           x=rep(0,nv),
           xend=texto$x,
           y=rep(0,nv),
           yend=texto$y,color="black",lwd=.5)+
  geom_label(data=texto,aes(x=x,y=y,label=label),
             color="black",angle=0,fontface="bold",size=3,fill="white")+
  labs(x=paste("CP1 (",round(100*ve[1],2),"%)",sep=""),
       y=paste("CP2 (",round(100*ve[2],2),"%)",sep=""),
       color="",shape="")+
  theme(legend.position = "top")+
  xlim(min(pc1c)*1.5,max(pc1c)*1.5) 
print(bi_plot)
```


```{r}
ck<-sum(pca$sdev^2>=0.98)
tabelapca<-vector()
for( l in 1:ck) tabelapca<-cbind(tabelapca,mcor[,l])
colnames(tabelapca)<-paste(rep(c("PC"),ck),1:ck,sep="")
pcat<-round(tabelapca,3)
tabelapca<-tabelapca[order(abs(tabelapca[,1])),]
print(tabelapca)
```













